# CloudFlare Origin Certificate Setup for ALB

## Overview

This guide explains how to configure CloudFlare Origin Certificates to enable CloudFlare proxy mode (`proxied: true`) with your AWS Application Load Balancer (ALB).

## The Problem

When using CloudFlare proxy mode with ALB, CloudFlare makes an HTTPS connection to your origin (ALB) to verify the SSL certificate:

```
Client → CloudFlare (CloudFlare Universal SSL) → ALB (Origin Certificate)
```

**Issue:** The ALB hostname is auto-generated by AWS:
```
k8s-llmgatew-openwebu-5d1360aa5a-1101013781.us-east-1.elb.amazonaws.com
```

But your ACM certificate is for:
```
openwebui.bhenning.com
*.bhenning.com
```

**Certificate hostname mismatch!** CloudFlare's SSL mode "Full (strict)" rejects the connection because the certificate doesn't match the ALB hostname.

## The Solution: CloudFlare Origin Certificates

CloudFlare Origin Certificates are SSL certificates issued by CloudFlare specifically for the connection between CloudFlare's edge and your origin server (ALB). These certificates:

- Are **only trusted by CloudFlare** (not by browsers directly)
- Can cover multiple hostnames (wildcard support)
- Are valid for up to 15 years
- Are completely **free**
- Solve the hostname mismatch problem

## Architecture

### Without CloudFlare Proxy (DNS-only mode):
```
Client → ALB (ACM Certificate for openwebui.bhenning.com) → OpenWebUI
```

### With CloudFlare Proxy + Origin Certificate:
```
Client → CloudFlare (Universal SSL) → ALB (CloudFlare Origin Cert) → OpenWebUI
       [Encrypted]                    [Encrypted]
```

**Two-layer SSL:**
1. **Client ↔ CloudFlare**: CloudFlare Universal SSL (trusted by browsers)
2. **CloudFlare ↔ ALB**: CloudFlare Origin Certificate (trusted by CloudFlare)

## Prerequisites

- CloudFlare account with domain configured
- AWS ALB already configured with ACM certificate
- Terraform setup from `terraform/eks/`
- CloudFlare credentials (API Token or Global API Key)

## Implementation Steps

### Step 1: Generate CloudFlare Origin Certificate

1. **Go to CloudFlare Dashboard**
   - Navigate to your domain
   - Click **SSL/TLS** → **Origin Server**

2. **Create Certificate**
   - Click **"Create Certificate"**

3. **Configure Certificate Settings**
   - **Private key type**: RSA (2048) - recommended for AWS compatibility
   - **Hostnames**:
     ```
     openwebui.bhenning.com
     *.bhenning.com
     ```
     This covers both the specific subdomain and wildcard

   - **Certificate validity**: 15 years (maximum)
   - **Format**: PEM (default)

4. **Generate Certificate**
   - Click **"Create"**
   - CloudFlare will show you two text blocks:
     - **Origin Certificate** (starts with `-----BEGIN CERTIFICATE-----`)
     - **Private Key** (starts with `-----BEGIN PRIVATE KEY-----`)

5. **⚠️ CRITICAL: Save Both Immediately**
   - CloudFlare only shows the private key **once**
   - If you lose it, you must generate a new certificate
   - Keep these secure - they're the keys to your SSL encryption

### Step 2: Save Certificate Files Securely

On your local machine or server:

```bash
# Create the origin certificate file
cat > /tmp/cloudflare-origin.crt << 'EOF'
-----BEGIN CERTIFICATE-----
[Paste the Origin Certificate here - entire block including BEGIN/END lines]
-----END CERTIFICATE-----
EOF

# Create the private key file
cat > /tmp/cloudflare-origin.key << 'EOF'
-----BEGIN PRIVATE KEY-----
[Paste the Private Key here - entire block including BEGIN/END lines]
-----END PRIVATE KEY-----
EOF

# Secure the private key (important!)
chmod 600 /tmp/cloudflare-origin.key

# Verify files were created correctly
ls -lh /tmp/cloudflare-origin.*
```

**Expected output:**
```
-rw-r--r-- 1 user user 1.7K Jan  6 21:00 /tmp/cloudflare-origin.crt
-rw------- 1 user user 1.7K Jan  6 21:00 /tmp/cloudflare-origin.key
```

### Step 3: Import Certificate to AWS ACM

Import the CloudFlare Origin Certificate into AWS Certificate Manager:

```bash
# Import the certificate
aws acm import-certificate \
  --certificate fileb:///tmp/cloudflare-origin.crt \
  --private-key fileb:///tmp/cloudflare-origin.key \
  --region us-east-1 \
  --tags Key=Name,Value=cloudflare-origin-openwebui Key=Type,Value=CloudFlareOrigin

# This will output the certificate ARN - SAVE IT!
```

**Expected output:**
```json
{
    "CertificateArn": "arn:aws:acm:us-east-1:667778672048:certificate/NEW-CERT-ID-HERE"
}
```

**⚠️ Save this ARN** - you'll need it for the next step.

### Step 4: Update Terraform Configuration

Update the ACM certificate ARN in your Terraform configuration:

```bash
cd /home/henninb/projects/github.com/henninb/llm-gateway

# Edit the tfvars file
nano terraform/eks/terraform.tfvars
```

**Find line 12 and replace with the new certificate ARN:**

```hcl
# BEFORE (old ACM certificate)
acm_certificate_arn = "arn:aws:acm:us-east-1:667778672048:certificate/52c0714b-ab17-4466-9959-52d9288b6249"

# AFTER (new CloudFlare Origin Certificate)
acm_certificate_arn = "arn:aws:acm:us-east-1:667778672048:certificate/NEW-CERT-ID-HERE"
```

Replace `NEW-CERT-ID-HERE` with the ARN from Step 3.

### Step 5: Apply Terraform Changes

Apply the Terraform changes to update the ALB with the new certificate:

```bash
cd terraform/eks

# Review the changes (should show ALB listener certificate update)
terraform plan

# Apply the changes
terraform apply -auto-approve
```

**Expected changes:**
```
# kubernetes_ingress_v1.openwebui[0] will be updated in-place
~ annotations = {
    ~ "alb.ingress.kubernetes.io/certificate-arn" = "arn:aws:acm:us-east-1:667778672048:certificate/52c0714b-ab17-4466-9959-52d9288b6249" -> "arn:aws:acm:us-east-1:667778672048:certificate/NEW-CERT-ID-HERE"
  }
```

The ALB will automatically update the HTTPS listener to use the new certificate.

### Step 6: Configure CloudFlare SSL Mode

Set CloudFlare to validate the origin certificate:

1. **Go to CloudFlare Dashboard** → Your domain
2. Click **SSL/TLS** → **Overview**
3. **Set SSL/TLS encryption mode** to one of:
   - **"Full (strict)"** - Recommended. CloudFlare validates the origin certificate.
   - **"Full"** - CloudFlare encrypts but doesn't validate hostname (less secure)

**Use "Full (strict)"** for maximum security now that you have a proper origin certificate.

### Step 7: Enable CloudFlare Proxy Mode

Enable the CloudFlare proxy (orange cloud):

**Option A: Via Make command**
```bash
cd /home/henninb/projects/github.com/henninb/llm-gateway
make eks-verify-cloudflare-dns DOMAIN=openwebui.bhenning.com
```

The script will detect that proxy mode should be enabled and configure it.

**Option B: Manually in CloudFlare Dashboard**
1. Go to **DNS** → **Records**
2. Find the `openwebui` CNAME record
3. Click to enable the **orange cloud** ☁️ (Proxied)
4. Save

### Step 8: Clean Up Sensitive Files

After importing the certificate to ACM, **delete the temporary files**:

```bash
# Securely delete the certificate files
rm -f /tmp/cloudflare-origin.crt
rm -f /tmp/cloudflare-origin.key

# Verify deletion
ls /tmp/cloudflare-origin.* 2>&1
# Should return: No such file or directory
```

## Verification

### 1. Verify Certificate in ACM

```bash
aws acm describe-certificate \
  --certificate-arn arn:aws:acm:us-east-1:667778672048:certificate/NEW-CERT-ID-HERE \
  --region us-east-1 \
  --query 'Certificate.{DomainName:DomainName,SubjectAlternativeNames:SubjectAlternativeNames,Status:Status,Issuer:Issuer}' \
  --output json
```

**Expected output:**
```json
{
  "DomainName": "openwebui.bhenning.com",
  "SubjectAlternativeNames": [
    "openwebui.bhenning.com",
    "*.bhenning.com"
  ],
  "Status": "ISSUED",
  "Issuer": "CloudFlare, Inc."
}
```

✅ **Issuer: CloudFlare, Inc.** - Confirms it's a CloudFlare Origin Certificate

### 2. Verify ALB Listener Certificate

```bash
# Get ALB ARN
ALB_ARN=$(aws elbv2 describe-load-balancers \
  --query 'LoadBalancers[?contains(LoadBalancerName, `k8s-llmgatew-openwebu`)].LoadBalancerArn' \
  --output text)

# Get listener certificate
aws elbv2 describe-listeners \
  --load-balancer-arn $ALB_ARN \
  --query 'Listeners[?Port==`443`].Certificates[0].CertificateArn' \
  --output text
```

**Expected output:**
```
arn:aws:acm:us-east-1:667778672048:certificate/NEW-CERT-ID-HERE
```

✅ Matches the CloudFlare Origin Certificate ARN

### 3. Verify DNS Resolution

```bash
dig +short openwebui.bhenning.com
```

**Expected output (with proxy enabled):**
```
172.67.191.228
104.21.20.77
```

✅ **Resolves to CloudFlare IPs** - Proxy mode is active

### 4. Verify HTTPS Access Works

```bash
curl -I https://openwebui.bhenning.com
```

**Expected output:**
```
HTTP/2 200
date: Tue, 06 Jan 2026 21:50:00 GMT
content-type: text/html; charset=utf-8
server: uvicorn
cf-ray: ...
cf-cache-status: DYNAMIC
```

✅ **HTTP 200** - Success!
✅ **cf-ray header** - Confirms traffic went through CloudFlare

### 5. Verify SSL Certificate (Browser Perspective)

```bash
openssl s_client -connect openwebui.bhenning.com:443 -servername openwebui.bhenning.com < /dev/null 2>&1 | grep -A 5 "Certificate chain"
```

**Expected output:**
```
Certificate chain
 0 s:CN=openwebui.bhenning.com
   i:C=US, O=CloudFlare, Inc., CN=CloudFlare Inc ECC CA-3
```

✅ Client sees CloudFlare's Universal SSL certificate (not the origin certificate)

### 6. Verify CloudFlare is Validating Origin

Check CloudFlare dashboard:
1. Go to **SSL/TLS** → **Edge Certificates**
2. Look for **"Universal SSL Status"** - should be "Active Certificate"
3. Go to **SSL/TLS** → **Origin Server** - should show your origin certificate

## Troubleshooting

### CloudFlare Shows SSL Error "526: Invalid SSL Certificate"

**Symptom:**
```
Error 526: Invalid SSL certificate
```

**Causes:**
- Origin certificate not installed on ALB
- Terraform not applied (ALB still using old certificate)
- Certificate expired or malformed

**Solution:**
```bash
# Verify certificate is in ACM
aws acm list-certificates --region us-east-1 | grep cloudflare-origin

# Verify ALB is using the certificate
aws elbv2 describe-listeners --load-balancer-arn $ALB_ARN

# Re-apply Terraform if needed
cd terraform/eks && terraform apply
```

### CloudFlare Shows SSL Error "525: SSL Handshake Failed"

**Symptom:**
```
Error 525: SSL handshake failed
```

**Causes:**
- CloudFlare SSL mode is "Full (strict)" but certificate doesn't match
- Private key doesn't match certificate
- Certificate file was corrupted during import

**Solution:**
```bash
# Check certificate matches private key
openssl x509 -noout -modulus -in /tmp/cloudflare-origin.crt | openssl md5
openssl rsa -noout -modulus -in /tmp/cloudflare-origin.key | openssl md5
# Both MD5 hashes should match

# If they don't match, re-generate certificate from CloudFlare
```

### Site Works via Direct ALB URL but Not via Domain

**Symptom:**
```bash
# This works
curl https://k8s-llmgatew-openwebu-5d1360aa5a-1101013781.us-east-1.elb.amazonaws.com

# This doesn't work
curl https://openwebui.bhenning.com
```

**Causes:**
- CloudFlare proxy mode enabled but certificate not configured
- CloudFlare SSL mode is "Off" or "Flexible"

**Solution:**
1. Verify CloudFlare SSL mode is "Full" or "Full (strict)"
2. Verify CloudFlare proxy is enabled (orange cloud)
3. Check CloudFlare SSL/TLS → Overview for error messages

### Certificate Shows as "PENDING_VALIDATION" in ACM

**Symptom:**
```bash
aws acm describe-certificate --certificate-arn ... | grep Status
# Status: PENDING_VALIDATION
```

**Cause:**
- This shouldn't happen with imported certificates
- Only AWS-issued certificates require validation

**Solution:**
- CloudFlare Origin Certificates are **imported**, not issued by AWS
- Status should show "ISSUED" immediately
- If showing PENDING_VALIDATION, you may have requested a certificate instead of importing
- Delete it and re-import using `aws acm import-certificate`

### DNS Still Resolves to ALB Hostname Instead of CloudFlare IPs

**Symptom:**
```bash
dig +short openwebui.bhenning.com
# k8s-llmgatew-openwebu-5d1360aa5a-1101013781.us-east-1.elb.amazonaws.com
```

**Cause:**
- CloudFlare proxy mode is disabled (grey cloud)
- DNS record is not using CloudFlare nameservers

**Solution:**
```bash
# Check CloudFlare proxy status
make eks-verify-cloudflare-dns DOMAIN=openwebui.bhenning.com

# Or manually enable in CloudFlare dashboard
# DNS → Records → Click orange cloud next to record
```

### ALB Returns 502 Bad Gateway After Certificate Update

**Symptom:**
```
HTTP/2 502
```

**Causes:**
- Target group health checks failing
- Pods not running or not responding
- Certificate update caused ALB to restart listeners

**Solution:**
```bash
# Check target group health
aws elbv2 describe-target-health \
  --target-group-arn $(aws elbv2 describe-target-groups \
    --query 'TargetGroups[?contains(TargetGroupName, `k8s-llmgatew-openweb`)].TargetGroupArn' \
    --output text)

# Check pod status
kubectl get pods -n llm-gateway -l app=openwebui

# Check pod logs
kubectl logs -n llm-gateway -l app=openwebui --tail=50
```

## Benefits of CloudFlare Origin Certificates

### Security
- ✅ **End-to-end encryption** - Traffic encrypted from client to ALB
- ✅ **DDoS protection** - CloudFlare's Layer 7 attack mitigation
- ✅ **Web Application Firewall** - Optional CloudFlare WAF
- ✅ **Hidden origin** - ALB hostname not exposed to attackers
- ✅ **Bot detection** - CloudFlare bot management

### Performance
- ✅ **Edge caching** - Static assets cached at CloudFlare's 300+ data centers
- ✅ **HTTP/3 support** - QUIC protocol for faster connections
- ✅ **Brotli compression** - Better compression than gzip
- ✅ **Auto-minification** - HTML/CSS/JS minification at edge

### Observability
- ✅ **CloudFlare Analytics** - Traffic insights and bot detection
- ✅ **Real client IP** - Preserved in `CF-Connecting-IP` header
- ✅ **Geographic data** - Country/region data in `CF-IPCountry` header
- ✅ **Cache analytics** - Cache hit rates and bandwidth savings

### Cost
- ✅ **Free** - CloudFlare Origin Certificates are free
- ✅ **Bandwidth savings** - CloudFlare caching reduces ALB egress costs
- ✅ **DDoS protection** - No additional cost for DDoS mitigation

## Certificate Lifecycle Management

### Renewal

CloudFlare Origin Certificates are valid for up to **15 years**. Set a calendar reminder to renew:

**Renewal Date:** [Date certificate was created] + 15 years

**Renewal Process:**
1. Generate new CloudFlare Origin Certificate (follow Step 1 above)
2. Import new certificate to ACM
3. Update `terraform.tfvars` with new ARN
4. Apply Terraform changes
5. Delete old certificate from ACM (optional - can keep as backup)

### Rotation

To rotate certificates before expiration:

```bash
# 1. Generate and import new certificate (Steps 1-3)
# 2. Update Terraform but DON'T delete old certificate yet
# 3. Apply Terraform - ALB switches to new certificate
# 4. Wait 24 hours to ensure everything works
# 5. Delete old certificate

aws acm delete-certificate \
  --certificate-arn arn:aws:acm:us-east-1:667778672048:certificate/OLD-CERT-ID \
  --region us-east-1
```

### Backup

Keep a backup of your CloudFlare Origin Certificate:

```bash
# Export current certificate from ACM
aws acm export-certificate \
  --certificate-arn arn:aws:acm:us-east-1:667778672048:certificate/CERT-ID \
  --passphrase $(openssl rand -base64 32) \
  --region us-east-1

# Or store in AWS Secrets Manager
aws secretsmanager create-secret \
  --name llm-gateway/cloudflare-origin-cert-backup \
  --secret-string file:///tmp/cloudflare-origin-backup.json
```

## Alternative: AWS Certificate Manager Public Certificates

If you don't want to use CloudFlare proxy, you can use AWS-issued public certificates:

**Pros:**
- Automatic renewal by AWS
- Browser-trusted (no CloudFlare required)
- Free

**Cons:**
- Requires DNS or email validation
- Can't enable CloudFlare proxy (certificate hostname mismatch)
- No CloudFlare DDoS/WAF protection

**To switch back to AWS public certificate:**
1. Request new certificate from ACM for `openwebui.bhenning.com`
2. Validate via DNS (add CNAME record to CloudFlare)
3. Update `terraform.tfvars` with new ARN
4. Set CloudFlare to `proxied: false` (DNS-only mode)
5. Apply Terraform

## Files Modified

**Created:**
- CloudFlare Origin Certificate files (temporary, deleted after import)

**Modified:**
- `terraform/eks/terraform.tfvars` - Updated `acm_certificate_arn` variable

**AWS Resources Created:**
- ACM imported certificate (CloudFlare Origin Certificate)

**AWS Resources Modified:**
- ALB HTTPS listener - Updated to use new certificate

## References

- [CloudFlare Origin Certificates Documentation](https://developers.cloudflare.com/ssl/origin-configuration/origin-ca/)
- [AWS ACM Import Certificate Documentation](https://docs.aws.amazon.com/acm/latest/userguide/import-certificate.html)
- [CloudFlare SSL/TLS Encryption Modes](https://developers.cloudflare.com/ssl/origin-configuration/ssl-modes/)
- [AWS ALB Listener Certificates](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/listener-update-certificates.html)
- [CloudFlare Origin CA Root Certificates](https://developers.cloudflare.com/ssl/origin-configuration/origin-ca/#cloudflare-origin-ca-root-certificate)

## Summary

This guide walked you through setting up CloudFlare Origin Certificates to enable CloudFlare proxy mode with your AWS ALB. The key steps were:

1. ✅ Generate CloudFlare Origin Certificate (15-year validity)
2. ✅ Import certificate to AWS ACM
3. ✅ Update Terraform configuration with new certificate ARN
4. ✅ Apply Terraform to update ALB listener
5. ✅ Set CloudFlare SSL mode to "Full (strict)"
6. ✅ Enable CloudFlare proxy mode (`proxied: true`)
7. ✅ Verify end-to-end HTTPS works

You now have:
- End-to-end encryption (Client → CloudFlare → ALB)
- CloudFlare DDoS protection and WAF capabilities
- Edge caching and performance optimizations
- Hidden origin server (ALB hostname not exposed)

**Next Steps:**
- Enable CloudFlare WAF rules for additional security
- Configure CloudFlare Page Rules for caching optimization
- Set up CloudFlare Analytics dashboards
- Consider CloudFlare Workers for edge computing
